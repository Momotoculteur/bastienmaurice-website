---
date: 2023-10-29
authors: [bmaurice]
title: Stack de monitoring performante sous Grafana - De Prometheus/Loki/Mimir √† Vector/VictoriaMetrics
categories:
  - Monitoring
tags:
  - monitoring
  - dashboard
  - grafana
  - mimir
  - loki
  - vector
  - kubernetes
  - kube state metrics
  - victoria metrics
  - prometheus
  - influxdb
  - timescaledb

comments: true
---

# Stack de monitoring performante sous Grafana - De Prometheus/Loki/Mimir √† Vector/VictoriaMetrics

Quand on souhaite monter une stack de monitoring, on pense bien entendu √† Grafana pour la r√©alisation de ses dashboard. <br><br>
Pour remonter toute nos infos √† celui-ci, on pense Prometheus pour les m√©triques, Loki pour les logs, et Mimir pour le stockage.  <br><br>
Mais n'existe t-il pas de nouveaux framework moins gourmant en ressource que cette traditionnel stack ? ü§î

<!-- more -->

## Comparaison entre les divers stack
Avant que j'aille plus loins dans l'explication de ma stack que je propose et qui me semble plus optimis√© en terme de consomation de ressource, commen√ßons par voir le basique, √† savoir ce qui se fait de nos jours qui est commun. Je te montre ensuite ce qui me semble mieux, que j'ai mis en place et surtout en quoi elle est mieux :smile:

### Stack mainstream schema
On peut retrouver chez pas mal d'entreprise, une stack assez commune pour la gestion des logs et m√©triques. C'est facile √† mettre en place, commun en terme d'utilisation et de technos, de documentation et de communaut√©.

![Stack ancienne generation](../../ressource/blog/monitoring-stack/data-pipeline-old-stack-grafana-prometheus-mimir-loki.png)

- **Kubernetes**, ici je parle de m√©triques internes √† k8s qui sont expos√©s, ou de tes divers services qui tournent et qui crash des logs
- **Grafana loki**, responsable de r√©cuperer les logs expos√©s dans ton cluster
- **Prometheus**, responsable de r√©cuperer les m√©triues expos√©es dans ton cluster
- **Grafana mimir**, est la database pour stocker tes logs/metriques sur du long terme
- **Grafana**, afin de cr√©er tes dashboard. Ceux-ci iront lire les donn√©es dans Mimir dans notre cas 

### Stack plus r√©cente & optimis√© schema
![Stack nouvelle generation](../../ressource/blog/monitoring-stack/data-pipeline-new-stack-victoriametrics-vector-grafana-kubestatemetrics.png)

- **Kubernetes**, ici je parle de m√©triques internes √† k8s qui sont expos√©s, ou de tes divers services qui tournent et qui crash des logs
- **Kube state metrics**, permettant d'exposer d'avantage de metriques. Ce framework reste optionnel
- **Vector**, permet d'aller scrapper les m√©triques et logs que tu souhaites, de les reformater (j'y reviendrais plus bas)
- **VictoriaMetrics**, qui permet le stockage de long terme des donn√©es
- **Grafana**, afin de cr√©er tes dashboard. Ceux-ci iront lire les donn√©es dans VictoriaMetrics dans notre cas 


### Avantage & inconv√©nients de chaque stack
Au fil du temps, on va cr√©er de plus en plus de dashboard, et donc se baser sur d'avantages de m√©triques, et/ou de logs applicatifs. On continue ainsi √† allourdir la stack avec le d√©veloppement croissant de nos services. Un des soucis majeur, une fois votre stack qui fonctionne en production, va √™tre la consommation en ressource de notre stockage de logs. On tombe nez √† nez fasse √† deux soucis :  

1. Le stockage coute plus cher chez votre cloud provider  
2. Le requ√™tage des datas dans notre base de donn√©es, depuis nos dashboard, deviennent de plus en plus longs √† s'afficher   

C'est un soucis que l'on rencontre avec notre premi√®re stack. On peut √©videmment diminuer notre nombre de m√©triques scrapp√©, ainsi que les logs, ou encore la fr√©quence de scrapping ou encore diminuer la r√©tention des donn√©es dans notre base. Mais moins de donn√©es √©quivaut √† diminuer les fonctionnalit√©s de notre monitoring.

C'est ici que resort 2 nouveaux framework, Vector et VictoriaMetrics, qui se veulent plus l√©ger et moins gourmand en ressource.


## Vector
Vector est extremement bien fourni :

- Nombre incroyable d'inputs de datas (source)
- Nombre incroyable d'outputs de datas (sinks)
- Langage sp√©cifique propri√©taire (VRL), permettant tr√®s facilement de modifier nos donn√©es
- construction complexe de pipeline
- √©crit en rust et donc tr√®s performant
- free & open source


![Vector features](../../ressource/blog/vector/vector-features.png)

En terme de performances, √ßa outpass la concurrence de fa√ßon g√©n√©ral ou √ßa reste dans le top 
![Vector performances](../../ressource/blog/vector/vector-performance.png)

## VictoriaMetrics
VictoriaMetrics peut √™tre un remplacement direct de Prometheus car : 

- free & open source
- √©crit en go et donc tr√®s performant. 
- peut remplacer Prometheus car utilise du MetricsQL, construit sur du PromQL le language de query de Prometheus avec de nouvelles fontionnalit√©s
- se plug donc directement √† Vector avec le m√™me sink que Prometheus
- se plug directement √† Grafana pour les dashboard √† la place de Grafana Mimir (n√©c√©ssite seuelement l'ajout d'une plugin pour ajouter cette data source)

Si on parle de performances pures, on est sur du :

- 10X moins gourmant en RAM que InfluxDB, et jusqu'a 7X moins gourmant en RAM que Prometheus/Cortex/Thanos
- En terme de data ingestion et query, 20X meilleur que InfluxDB/TimescaleDB
- Meilleurs algos de compression et use 7X moins de disque storage que Prometheus/Cortex/Thanos

![Prometheus vs VictoriaMetrics for Disk Space](../../ressource/blog/victoria-metrics/prometheus-vs-victoriametrics-disk-space.png)

![Prometheus vs VictoriaMetrics for memory usage](../../ressource/blog/victoria-metrics/prometheus-vs-victoriametrics-memory-usage.png)

Source:  
https://github.com/vectordotdev/vector  
https://github.com/VictoriaMetrics/VictoriaMetrics  
https://valyala.medium.com/measuring-vertical-scalability-for-time-series-databases-in-google-cloud-92550d78d8ae  
https://valyala.medium.com/prometheus-vs-victoriametrics-benchmark-on-node-exporter-metrics-4ca29c75590f  
https://valyala.medium.com/when-size-matters-benchmarking-victoriametrics-vs-timescale-and-influxdb-6035811952d4  